# cda-generator 
Can be used for generation mockups of structured electronic medical documents (SEMD) based on [standart HL7 CDA](http://www.hl7.org/implement/standards/product_brief.cfm?product_id=496).

### Requirements
* NodeJS v10+ 
* npm 
also possible to run `cda-generator` using `docker`

### Installation
Clone this repository
``` bash
git clone https://github.com/adn-tm/cda.git
```

### Command line usage
Install modules
``` bash
cd cda
npm install
```
Set up your template (read Templates section)
`templates`  

Run cda-generator in command-line mode 
``` bash
node index.js -s ./templates/66 -d ./dist -c 5
```
### Docker usage
Set up your config in the `docker-compose.yaml`

Run container
``` bash
docker-compose up -d
```
We provide some examples.
Generate XML files to local filesystem.
``` bash
docker-compose -f docker-compose.fs.yaml up -d 
```
Generate XML files and produce messages to Kafka
``` bash
docker-compose -f docker-compose.kafka.yaml up -d 
```

### Command line parameters and environment variable 
Possible parameters:
````
         -h(elp) online help 
         -s(rc) template_dir
                 path to template directory. Files config.json & template.xml are required there
                 It can be passed by $CDA_GEN_SRC environment variable
                 Default value is '/home/node/src'

         -d(st) destination_dir
                 path to exists directory for saving results into the file system
                 It can be passed by $CDA_GEN_DST environment variable
                 Default value is '/home/node/dst'

         -k(afka) brokers
                 Comma separated broker list, ex. 'kafka1:9092, kafka2:9092'.
                 It can be passed by $KAFKA_BROKERS environment variable
                 By default Kafka broker not used

         -t(opic) topic
                 Broker topic for pushing the produced data
                 It can be passed by $KAFKA_TOPIC environment variable

         Additional data for produced values of messages CAN been passed through the environment variable prefixed by 'CDA_GEN_MSG_'
                 Example:
                         export CDA_GEN_MSG_sourceType=ABD
                         export CDA_GEN_MSG_clientId=CDA-generator
         -c(nt) N
                 mocks count (default == 1 for files and INFINITY for Kafka destination)
                 It can be passed by $CDA_GEN_CNT environment variable

         -w(ait) N
                 delay (measured in ms) between each CDA generation
                 It can be passed by $CDA_GEN_DELAY environment variable
                 0 by default
````
## Work with templates
Template consist of couple files located in same directory:
- config.json - structure which describes data randomization (see description below)
- template.xml - XML text, with marked places for random data fullfilling. Variables must be separated by Handlebars rules by {{ }} (double curly brackets). All variables have to
been described in config.json. JsonPath strings (path through json object like a "a.b.c") are allowed.

### config.json

```json
{
  "xmlData": {
    "variable1":{
      "type": "known type from the list",
      "params": [ "params are described for each type" ]    
     }, 
    ....
  }
}
```

### Known types
- random - random values generated by params:
```
    1. [ [ value1, value2, ... ] ] - random item of value (any type)
    2. [ "ALPHABET", MaxLength ] - random string which combined with passed chars
    3. [ Start, Finish ] - random Number value in range(Start, Finish)
```
 
- Person
```
gender: enum("f", "m")
    genderName: enum("Женский", "Мужской")
    genderCode: enum(1,2)
    firstName: String - random name by russian names popularity (accoring to gender)
    lastName: String - random name by russian family-name popularity (accoring to gender)
    secondName: String - random name by russian secon-name popularity (accoring to gender)
    snils: String - СНИЛС code with valid CRC code digit
    oms: String - russian medical insurance code with valid CRC code digit
    inn: String - russian tax office INDIVIDUAL code with valid CRC code digit
    guid: GUID
    address: Address (see below)
    legalAddress: Address (see below)
    birthDate: Date - date of birth according to genders frequncy distribution
    dul: String - ID of passport (older that 14) or number of certificate of the birth (for children)
    deathDate: Date
```

- Organization
```
    id.oid: String - OID prefixed random value
    id.codeLnumber - random ID number
    guid:GUID
    // some business & account codes
    inn: String - russian tax office BUSINESS code with valid CRC code digit
    ogrn:String
    kpp:
    
    shorName:String
    fullName:String
    regAddress:Address
    postAddress:Address
```

- Address
```
    "postCode":"431220",
    "regType":"Респ",
    "region":"Мордовия",
    "districtType":"р-н",
    "district":"Темниковский",
    "cityType":"г",
    "city":"Темников",
    "typePlace":"",
    "place":"",
    "CLADR":"1302000100000",
    "FIAS":"7a57dd0c-5b64-480e-8369-3e22261e2bf0",
    "levelFIAS":"4: город",
    "isAdminCenter":"1",
    "OKATO":"89249501000",
    "OKTMO":"89649101001",
    "codeTaxOffice":"1314",
    "timezone":"UTC+3",
    "latitude":"54.6309086",
    "longitude":"43.2161785",
    "federalDistrict":"Приволжский",
    "population":"7247",
    "regionCode":String =codeTaxOffice.substring(0, 2),
    "street":String,
    "building": number,
    "flat":number,
    "office": number
```
#### Some primitive types & codes 
- Date
- Passport
- OGRN
- KPP
- SNILS
- OID
- OMS
- BirthSert
- INN_Person
- INN_Org
